# Fastfile
# fastlaneã®è‡ªå‹•åŒ–ã‚¿ã‚¹ã‚¯å®šç¾©

default_platform(:ios)

platform :ios do
  # TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹lane
  desc "TestFlightã«ãƒ“ãƒ«ãƒ‰ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :beta do
    # App Store Connect APIã‚­ãƒ¼ã®è¨­å®š
    api_key = app_store_connect_api_key(
      key_id: ENV["APP_STORE_CONNECT_API_KEY_ID"],
      issuer_id: ENV["APP_STORE_CONNECT_ISSUER_ID"],
      key_content: ENV["APP_STORE_CONNECT_API_KEY"],
      is_key_content_base64: true,
      duration: 500 # JWTãƒˆãƒ¼ã‚¯ãƒ³ã®æœ‰åŠ¹æœŸé™ã‚’500ç§’ï¼ˆç´„8åˆ†ï¼‰ã«è¨­å®š
    )

    # IPAãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’è¨­å®š
    ipa_path = "./ipa/BottleKeeper.ipa"

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    # æ³¨æ„: groupsãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å¤–éƒ¨ãƒ†ã‚¹ã‚¿ãƒ¼ç”¨ã§ã‚ã‚Šã€å†…éƒ¨ãƒ†ã‚¹ã‚¿ãƒ¼ã«ã¯é©ç”¨ä¸å¯
    # å†…éƒ¨ãƒ†ã‚¹ã‚¿ãƒ¼ã¸ã®è‡ªå‹•é…ä¿¡ã¯App Store Connectã§ã€Œè‡ªå‹•é…ä¿¡ã€ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã“ã¨
    upload_to_testflight(
      api_key: api_key,
      ipa: ipa_path,
      skip_waiting_for_build_processing: false, # ãƒ“ãƒ«ãƒ‰å‡¦ç†ã®å®Œäº†ã‚’å¾…ã¤
      skip_submission: true # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã¿ï¼ˆé…ä¿¡ã¯App Store Connectå´ã®è‡ªå‹•é…ä¿¡è¨­å®šã§è¡Œã†ï¼‰
    )

    UI.success("ğŸ‰ TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼")
    UI.message("App Store Connectã§ãƒ“ãƒ«ãƒ‰ã®å‡¦ç†çŠ¶æ³ã‚’ç¢ºèªã—ã¦ãã ã•ã„")
  end

  # ãƒ“ãƒ«ãƒ‰ã¨TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚’ä¸€åº¦ã«å®Ÿè¡Œã™ã‚‹lane
  desc "ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ã—ã¦TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰"
  lane :build_and_beta do
    # Xcodeã§ãƒ“ãƒ«ãƒ‰
    build_app(
      scheme: "BottleKeeper",
      export_method: "app-store",
      output_directory: "./ipa",
      output_name: "BottleKeeper.ipa",
      export_options: {
        provisioningProfiles: {
          "com.bottlekeep.whiskey" => "BottleKeep Distribution"
        }
      }
    )

    # TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
    beta
  end
end