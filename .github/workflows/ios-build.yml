name: iOS ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰

# ãƒˆãƒªã‚¬ãƒ¼è¨­å®š
on:
  push:
    branches: [ main ]  # mainãƒ–ãƒ©ãƒ³ãƒã¸ã®pushã§ãƒ“ãƒ«ãƒ‰ã‚’è‡ªå‹•å®Ÿè¡Œï¼ˆãƒ•ã‚§ãƒ¼ã‚ºAï¼‰
  pull_request:
    branches: [ main ]
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚’è¨±å¯

env:
  XCODE_VERSION: '16.2' # ä½¿ç”¨ã™ã‚‹Xcodeã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³
  SCHEME: 'BottleKeeper'
  PROJECT_PATH: 'BottleKeeper.xcodeproj' # ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
  BUNDLE_ID: 'com.bottlekeep.whiskey'

jobs:
  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã‚¸ãƒ§ãƒ–
  test:
    name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
    runs-on: macos-14 # iOS 26 Betaå•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚macOS-14ã‚’ä½¿ç”¨

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: DerivedDataã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-${{ hashFiles('**/*.swift', '**/*.xcodeproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-

      - name: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        run: |
          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã§ã‚¢ãƒ—ãƒªã‚’ãƒ“ãƒ«ãƒ‰ï¼†ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ”¨ DEBUG ãƒ“ãƒ«ãƒ‰ã§ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          xcodebuild build \
            -project BottleKeeper.xcodeproj \
            -scheme BottleKeeper \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro' \
            -configuration Debug \
            -derivedDataPath $RUNNER_TEMP/DerivedData \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO

          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼IDã‚’å–å¾—
          SIMULATOR_ID=$(xcrun simctl list devices available | grep "iPhone 16 Pro" | head -n 1 | grep -o "[0-9A-F-]\{36\}")

          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆï¼ˆUserDefaultsã‚’ã‚¯ãƒªã‚¢ã—ã¦æ–°ã‚³ãƒ³ãƒ†ãƒŠã§ã®ã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã‚’ç¢ºå®Ÿã«ã™ã‚‹ï¼‰
          echo "ğŸ”„ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’ãƒªã‚»ãƒƒãƒˆä¸­..."
          xcrun simctl erase "$SIMULATOR_ID"
          echo "âœ… ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆå®Œäº†"

          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èµ·å‹•
          echo "ğŸ“± ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã‚’èµ·å‹•ä¸­..."
          xcrun simctl boot "$SIMULATOR_ID" || echo "ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ã¯æ—¢ã«èµ·å‹•æ¸ˆã¿"

          # ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          echo "ğŸ“¦ ã‚¢ãƒ—ãƒªã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­..."
          APP_PATH=$(find $RUNNER_TEMP/DerivedData -name "BottleKeeper.app" | head -n 1)
          xcrun simctl install "$SIMULATOR_ID" "$APP_PATH"

          # ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ã—ã¦CloudKitã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã‚’å®Ÿè¡Œ
          echo "ğŸš€ ã‚¢ãƒ—ãƒªã‚’èµ·å‹•ä¸­ï¼ˆCloudKitã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã®ãŸã‚ï¼‰..."
          echo "â„¹ï¸ DEBUGãƒ“ãƒ«ãƒ‰ã§ã¯ã€CoreDataManagerãŒè‡ªå‹•çš„ã«ã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ã‚’è©¦è¡Œã—ã¾ã™"

          # ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ã‚°ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§å–å¾—ã™ã‚‹ãŸã‚ã«ã€åˆ¥ãƒ—ãƒ­ã‚»ã‚¹ã§èµ·å‹•
          xcrun simctl launch --console "$SIMULATOR_ID" com.bottlekeep.whiskey 2>&1 | tee simulator.log &
          LAUNCH_PID=$!

          # 60ç§’å¾…æ©Ÿï¼ˆã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ãŒå®Œäº†ã™ã‚‹ã¾ã§ï¼‰
          # ä»¥å‰ã®30ç§’ã§ã¯ä¸ååˆ†ã ã£ãŸå¯èƒ½æ€§ãŒã‚ã‚‹ãŸã‚ã€60ç§’ã«å»¶é•·
          echo "â³ CloudKitã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–å®Œäº†ã‚’å¾…æ©Ÿä¸­ï¼ˆ60ç§’ï¼‰..."
          sleep 60

          # ãƒ­ã‚°ã‹ã‚‰é‡è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡º
          echo "ğŸ“‹ ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ãƒ­ã‚°ã‹ã‚‰é‡è¦ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æŠ½å‡ºä¸­..."
          if [ -f simulator.log ]; then
            echo "=== ã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–é–¢é€£ãƒ­ã‚° ==="
            grep -i "cloudkit\|schema\|_pcs_data\|error 134060\|initialized" simulator.log || echo "é–¢é€£ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ"
          fi

          # ã‚¢ãƒ—ãƒªã‚’çµ‚äº†
          echo "ğŸ›‘ ã‚¢ãƒ—ãƒªã‚’çµ‚äº†ä¸­..."
          xcrun simctl terminate "$SIMULATOR_ID" com.bottlekeep.whiskey || true
          kill $LAUNCH_PID 2>/dev/null || true

          echo "âœ… CloudKitã‚¹ã‚­ãƒ¼ãƒåˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹å®Œäº†ï¼ˆDevelopmentç’°å¢ƒï¼‰"
          echo "â„¹ï¸ CloudKit Dashboardã§ã‚¹ã‚­ãƒ¼ãƒãŒæ­£ã—ãä½œæˆã•ã‚ŒãŸã‹ç¢ºèªã—ã¦ãã ã•ã„"

      - name: ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults

  # ãƒ“ãƒ«ãƒ‰ã‚¸ãƒ§ãƒ–
  build:
    name: ã‚¢ãƒ—ãƒªãƒ“ãƒ«ãƒ‰
    runs-on: macos-14 # iOS 26 Betaå•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚macOS-14ã‚’ä½¿ç”¨
    needs: test # ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ãŸå¾Œã«å®Ÿè¡Œ

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Xcodeãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¨­å®š
        run: |
          sudo xcode-select -s /Applications/Xcode_${{ env.XCODE_VERSION }}.app
          xcodebuild -version

      - name: DerivedDataã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å¾©å…ƒ
        uses: actions/cache@v4
        with:
          path: ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-deriveddata-build-${{ hashFiles('**/*.swift', '**/*.xcodeproj') }}
          restore-keys: |
            ${{ runner.os }}-deriveddata-build-
            ${{ runner.os }}-deriveddata-

      - name: è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        env:
          BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
          P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
          BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64_NEW || secrets.BUILD_PROVISION_PROFILE_BASE64 }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # è¨¼æ˜æ›¸ã¨ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ä½œæˆ
          CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
          PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db

          # Base64ãƒ‡ã‚³ãƒ¼ãƒ‰ã—ã¦ä¿å­˜
          echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH
          echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

          # ä¸€æ™‚çš„ãªã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’ä½œæˆ
          security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
          security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

          # è¨¼æ˜æ›¸ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
          security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
          security list-keychain -d user -s $KEYCHAIN_PATH

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles

          # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®åå‰ã‚’å‹•çš„ã«å–å¾—
          echo "=== ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª ==="

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®å†…å®¹ã‚’ãƒ‡ã‚³ãƒ¼ãƒ‰
          PROFILE_CONTENT=$(security cms -D -i $PP_PATH)

          # å„å€¤ã‚’å®‰å…¨ã«æŠ½å‡ºï¼ˆã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ãï¼‰
          PROFILE_NAME=$(echo "$PROFILE_CONTENT" | plutil -extract Name raw - 2>/dev/null || echo "")
          PROFILE_UUID=$(echo "$PROFILE_CONTENT" | plutil -extract UUID raw - 2>/dev/null || echo "")

          # Team IDã¯è¤‡æ•°ã®å ´æ‰€ã«ã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹ã®ã§ã€é †ç•ªã«è©¦è¡Œ
          PROFILE_TEAM_ID=""
          if [ -z "$PROFILE_TEAM_ID" ]; then
            # ApplicationIdentifierPrefixã®æœ€åˆã®è¦ç´ ã‚’å–å¾—ï¼ˆæœ€ã‚‚ç¢ºå®Ÿï¼‰
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract ApplicationIdentifierPrefix.0 raw - 2>/dev/null || echo "")
          fi
          if [ -z "$PROFILE_TEAM_ID" ]; then
            # Entitlementså†…ã®com.apple.developer.team-identifier
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract Entitlements.com.apple.developer.team-identifier raw - 2>/dev/null || echo "")
          fi
          if [ -z "$PROFILE_TEAM_ID" ]; then
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract TeamIdentifier raw - 2>/dev/null || echo "")
          fi
          if [ -z "$PROFILE_TEAM_ID" ]; then
            # TeamIdentifierãŒé…åˆ—ã®å ´åˆ
            PROFILE_TEAM_ID=$(echo "$PROFILE_CONTENT" | plutil -extract TeamIdentifier.0 raw - 2>/dev/null || echo "")
          fi

          # ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®Team IDã‚’è¨­å®š
          if [ -z "$PROFILE_TEAM_ID" ]; then
            PROFILE_TEAM_ID="KRVLW3Y2SL"
            echo "âš ï¸ Team IDãŒæŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã‚’ä½¿ç”¨ã—ã¾ã™: $PROFILE_TEAM_ID"
          fi

          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«å: $PROFILE_NAME"
          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«UUID: $PROFILE_UUID"
          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«Team ID: $PROFILE_TEAM_ID"
          echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          echo "PROFILE_UUID=$PROFILE_UUID" >> $GITHUB_ENV
          echo "PROFILE_TEAM_ID=$PROFILE_TEAM_ID" >> $GITHUB_ENV

          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³ã‚’è©³ç´°ç¢ºèª
          echo "=== ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®å†…å®¹ç¢ºèª ==="
          ls -la ~/Library/MobileDevice/Provisioning\ Profiles/

          echo "=== ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°æƒ…å ±ç¢ºèª ==="
          security cms -D -i $PP_PATH | plutil -p -

          echo "=== ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ ==="
          find ~/Library/MobileDevice/Provisioning\ Profiles/ -name "*.mobileprovision" -exec basename {} \; 2>/dev/null || echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"

      - name: ãƒ“ãƒ«ãƒ‰ç•ªå·ã‚’è‡ªå‹•æ›´æ–°
        run: |
          BUILD_NUMBER=$GITHUB_RUN_NUMBER
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_ENV
          echo "ãƒ“ãƒ«ãƒ‰ç•ªå·: $BUILD_NUMBER"

          # PlistBuddyã‚’ä½¿ç”¨ã—ã¦Info.plistã®CFBundleVersionã‚’æ›´æ–°
          INFO_PLIST_PATH="BottleKeeper/Info.plist"
          echo "ğŸ“ CFBundleVersionã‚’${BUILD_NUMBER}ã«æ›´æ–°ä¸­..."

          # ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’è¡¨ç¤º
          CURRENT_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$INFO_PLIST_PATH")
          echo "ç¾åœ¨ã®CFBundleVersion: $CURRENT_VERSION"

          # æ–°ã—ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã«æ›´æ–°
          /usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "$INFO_PLIST_PATH"

          # æ›´æ–°çµæœã‚’ç¢ºèª
          NEW_VERSION=$(/usr/libexec/PlistBuddy -c "Print CFBundleVersion" "$INFO_PLIST_PATH")
          echo "âœ… CFBundleVersionæ›´æ–°å®Œäº†: $CURRENT_VERSION â†’ $NEW_VERSION"

      - name: ãƒªãƒªãƒ¼ã‚¹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã‚’ãƒ“ãƒ«ãƒ‰
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ—ï¸ ãƒªãƒªãƒ¼ã‚¹ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰é–‹å§‹"
          echo "ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«: ${PROFILE_NAME:-BottleKeeper Distribution}"
          echo "Team ID: ${PROFILE_TEAM_ID:-KRVLW3Y2SL}"

          ARCHIVE_SUCCESS=false

          # åå‰ã§ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰
          if xcodebuild archive \
            -project BottleKeeper.xcodeproj \
            -scheme BottleKeeper \
            -destination 'generic/platform=iOS' \
            -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
            -configuration Release \
            -quiet \
            DEVELOPMENT_TEAM="${PROFILE_TEAM_ID:-KRVLW3Y2SL}" \
            CODE_SIGN_STYLE=Manual \
            CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
            PROVISIONING_PROFILE_SPECIFIER="${PROFILE_NAME:-BottleKeeper Distribution}"; then
            ARCHIVE_SUCCESS=true
          elif [ -n "$PROFILE_UUID" ]; then
            # UUIDã§å†è©¦è¡Œ
            xcodebuild archive \
              -project BottleKeeper.xcodeproj \
              -scheme BottleKeeper \
              -destination 'generic/platform=iOS' \
              -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
              -configuration Release \
              -quiet \
              DEVELOPMENT_TEAM="${PROFILE_TEAM_ID:-KRVLW3Y2SL}" \
              CODE_SIGN_STYLE=Manual \
              CURRENT_PROJECT_VERSION="$BUILD_NUMBER" \
              PROVISIONING_PROFILE_SPECIFIER="$PROFILE_UUID" && ARCHIVE_SUCCESS=true
          fi

          # ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ã®ç¢ºèª
          if [ "$ARCHIVE_SUCCESS" = true ] && [ -d "$RUNNER_TEMP/BottleKeeper.xcarchive" ]; then
            echo "âœ… ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰å®Œäº†"
          else
            echo "âŒ ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ“ãƒ«ãƒ‰å¤±æ•—"
            exit 1
          fi

      - name: IPAã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        run: |
          echo "ğŸ“¦ IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆé–‹å§‹"

          # ExportOptions.plistã‚’å‹•çš„ç”Ÿæˆ
          cp ExportOptions.plist $RUNNER_TEMP/ExportOptions.plist
          sed -i '' "s/BottleKeeper Distribution/${PROFILE_NAME:-BottleKeeper Distribution}/g" $RUNNER_TEMP/ExportOptions.plist
          sed -i '' "s/KRVLW3Y2SL/$PROFILE_TEAM_ID/g" $RUNNER_TEMP/ExportOptions.plist

          # IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
          xcodebuild -exportArchive \
            -archivePath $RUNNER_TEMP/BottleKeeper.xcarchive \
            -exportPath $RUNNER_TEMP/ipa \
            -exportOptionsPlist $RUNNER_TEMP/ExportOptions.plist \
            -quiet

          echo "âœ… IPAã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†"

      - name: ãƒ“ãƒ«ãƒ‰æˆæœç‰©ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: BottleKeeper-IPA
          path: ${{ runner.temp }}/ipa/

      - name: ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        if: always()
        run: |
          # ã‚­ãƒ¼ãƒã‚§ãƒ¼ãƒ³ã‚’å‰Šé™¤
          security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
          # ãƒ—ãƒ­ãƒ“ã‚¸ãƒ§ãƒ‹ãƒ³ã‚°ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm -f ~/Library/MobileDevice/Provisioning\ Profiles/build_pp.mobileprovision || true

  # TestFlighté…ä¿¡ã‚¸ãƒ§ãƒ–ï¼ˆãƒ•ã‚§ãƒ¼ã‚ºB: å®Œå…¨è‡ªå‹•åŒ–ï¼‰
  deploy-testflight:
    name: TestFlightã¸é…ä¿¡
    runs-on: macos-14 # iOS 26 Betaå•é¡Œã‚’å›é¿ã™ã‚‹ãŸã‚macOS-14ã‚’ä½¿ç”¨
    needs: build
    if: (github.event_name == 'push' && github.ref == 'refs/heads/main') || github.event_name == 'workflow_dispatch'  # ãƒ•ã‚§ãƒ¼ã‚ºB: mainã¸ã®pushã¾ãŸã¯æ‰‹å‹•å®Ÿè¡Œã§é…ä¿¡

    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: IPAã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        uses: actions/download-artifact@v4
        with:
          name: BottleKeeper-IPA
          path: ./ipa

      - name: Rubyã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: fastlaneã§TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
        env:
          APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
          APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        run: |
          echo "ğŸš€ TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­..."

          # fastlaneã§TestFlightã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
          bundle exec fastlane beta

          echo "âœ… TestFlightã¸ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†"
          echo "ğŸ”— https://appstoreconnect.apple.com"

      - name: Slackã¸é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: success() && env.SLACK_WEBHOOK_URL != ''
        uses: slackapi/slack-github-action@v1
        with:
          payload: |
            {
              "text": "BottleKeeper v${{ github.run_number }} ãŒTestFlightã«é…ä¿¡ã•ã‚Œã¾ã—ãŸï¼",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*ğŸš€ BottleKeeper ãŒTestFlightã«é…ä¿¡ã•ã‚Œã¾ã—ãŸ*\nâ€¢ ãƒ“ãƒ«ãƒ‰ç•ªå·: ${{ github.run_number }}\nâ€¢ ãƒ–ãƒ©ãƒ³ãƒ: ${{ github.ref_name }}\nâ€¢ ã‚³ãƒŸãƒƒãƒˆ: ${{ github.sha }}"
                  }
                }
              ]
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL || '' }}